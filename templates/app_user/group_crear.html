{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'lib/select2-4.0.6-rc.1/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'lib/select2-4.0.6-rc.1/css/select2-bootstrap4.min.css' %}">
{% endblock %}

{% block contenido %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">
                    <i class="fas fa-users-cog"></i> Crear Grupo
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'inicio_dashboard' %}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'app_usuario:listar_grupo' %}">Grupos</a></li>
                    <li class="breadcrumb-item active">Crear Grupo</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users-cog mr-2"></i>
                            Configuración del Nuevo Grupo
                        </h3>
                    </div>

                    <form method="post" id="frmGroup">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="row">
                                <!-- Información Básica del Grupo -->
                                <div class="col-lg-4">
                                    <div class="card card-outline card-info">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-info-circle mr-2"></i>
                                                Información Básica
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="{{ form.name.id_for_label }}">
                                                    <i class="fas fa-tag mr-1"></i>
                                                    Nombre del Grupo *
                                                </label>
                                                {{ form.name }}
                                                <small class="form-text text-muted">
                                                    Ejemplo: Administradores, Operadores, Supervisores
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Módulos del Sistema -->
                                <div class="col-lg-8">
                                    <div class="card card-outline card-success">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-th-large mr-2"></i>
                                                Módulos del Sistema
                                            </h3>
                                            <div class="card-tools">
                                                <button type="button" class="btn btn-sm btn-success" id="selectAllModules">
                                                    <i class="fas fa-check-double"></i> Seleccionar Todos
                                                </button>
                                                <button type="button" class="btn btn-sm btn-warning" id="clearAllModules">
                                                    <i class="fas fa-times"></i> Limpiar Todo
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="{{ form.modulos.id_for_label }}">
                                                    <i class="fas fa-puzzle-piece mr-1"></i>
                                                    Selecciona los módulos a los que tendrá acceso este grupo
                                                </label>
                                                {{ form.modulos }}
                                                <small class="form-text text-muted">
                                                    Los módulos determinan qué secciones del sistema podrá ver el grupo
                                                </small>
                                            </div>

                                            <!-- Vista previa de módulos seleccionados -->
                                            <div id="selectedModulesPreview" class="mt-3" style="display: none;">
                                                <h6><i class="fas fa-eye mr-1"></i> Módulos Seleccionados:</h6>
                                                <div id="modulesList" class="d-flex flex-wrap"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Permisos del Sistema -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card card-outline card-warning">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-shield-alt mr-2"></i>
                                                Permisos del Sistema
                                            </h3>
                                            <div class="card-tools">
                                                <button type="button" class="btn btn-sm btn-success" id="selectAllPermissions">
                                                    <i class="fas fa-check-double"></i> Seleccionar Todos
                                                </button>
                                                <button type="button" class="btn btn-sm btn-warning" id="clearAllPermissions">
                                                    <i class="fas fa-times"></i> Limpiar Todo
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle mr-2"></i>
                                                <strong>Información:</strong> Los permisos determinan las acciones específicas que pueden realizar los usuarios de este grupo (crear, editar, eliminar, ver).
                                            </div>

                                            <div class="form-group">
                                                <label for="{{ form.permissions.id_for_label }}">
                                                    <i class="fas fa-key mr-1"></i>
                                                    Permisos Específicos
                                                </label>
                                                {{ form.permissions }}
                                                <small class="form-text text-muted">
                                                    Selecciona los permisos específicos para este grupo
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-footer">
                            <div class="row">
                                <div class="col-lg-6">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save mr-2"></i>
                                        Crear Grupo
                                    </button>
                                </div>
                                <div class="col-lg-6 text-right">
                                    <a href="{% url 'app_usuario:listar_grupo' %}" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-times mr-2"></i>
                                        Cancelar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{% static 'lib/select2-4.0.6-rc.1/js/select2.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Inicializar Select2
    $('#id_modulos').select2({
        theme: 'bootstrap4',
        placeholder: 'Selecciona los módulos del sistema...',
        allowClear: true
    });

    $('#id_permissions').select2({
        theme: 'bootstrap4',
        placeholder: 'Selecciona los permisos específicos...',
        allowClear: true
    });

    // Botones para seleccionar/limpiar módulos
    $('#selectAllModules').click(function() {
        $('#id_modulos option').prop('selected', true);
        $('#id_modulos').trigger('change');
    });

    $('#clearAllModules').click(function() {
        $('#id_modulos').val(null).trigger('change');
    });

    // Botones para seleccionar/limpiar permisos
    $('#selectAllPermissions').click(function() {
        $('#id_permissions option').prop('selected', true);
        $('#id_permissions').trigger('change');
    });

    $('#clearAllPermissions').click(function() {
        $('#id_permissions').val(null).trigger('change');
    });

    // Vista previa de módulos seleccionados
    $('#id_modulos').on('change', function() {
        const selectedModules = $(this).select2('data');
        const modulesList = $('#modulesList');
        const preview = $('#selectedModulesPreview');

        modulesList.empty();

        if (selectedModules.length > 0) {
            selectedModules.forEach(function(module) {
                modulesList.append(`
                    <span class="badge badge-primary mr-2 mb-2">
                        <i class="fas fa-puzzle-piece mr-1"></i>
                        ${module.text}
                    </span>
                `);
            });
            preview.show();
        } else {
            preview.hide();
        }
    });

    // Validación del formulario
    $('#frmGroup').on('submit', function(e) {
        const groupName = $('#id_name').val().trim();

        if (!groupName) {
            e.preventDefault();
            $('#id_name').addClass('is-invalid');
            toastr.error('El nombre del grupo es requerido');
            return false;
        }

        const selectedModules = $('#id_modulos').val();
        if (!selectedModules || selectedModules.length === 0) {
            e.preventDefault();
            toastr.warning('Se recomienda seleccionar al menos un módulo para el grupo');
        }
    });

    // Limpiar validación al escribir
    $('#id_name').on('input', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>
{% endblock %}